<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Quản Lý Săn Quái</title>
    <!-- Thêm vào phần head -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">         
    </script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>    
    <style>
/* --- Biến và Thiết lập Cơ bản --- */
:root {
    --primary-color: #3498db;
    --success-color: #2ecc71;
    --warning-color: #f1c40f;
    --danger-color: #e74c3c;
    --info-color: #9b59b6; /* Màu cho nút export ảnh */
    --secondary-color: #95a5a6; /* Màu cho nút toggle */
    --light-gray: #ecf0f1;
    --medium-gray: #bdc3c7;
    --dark-gray: #7f8c8d;
    --text-color: #34495e;
    --bg-color: #f4f7f9; /* Nền hơi xám nhẹ */
    --white-color: #ffffff;
    --border-radius-sm: 4px;
    --border-radius-md: 8px;
    --box-shadow-light: 0 2px 5px rgba(0, 0, 0, 0.08);
    --box-shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
    --transition-speed: 0.2s;
}

body {
    font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    margin: 0; /* Xóa margin mặc định */
    background-color: var(--bg-color);
    color: var(--text-color);
    line-height: 1.6;
}

/* --- Container Chính --- */
.main-container {
    max-width: 1400px; /* Giới hạn chiều rộng tối đa */
    margin: 20px auto; /* Căn giữa và tạo khoảng cách trên/dưới */
    padding: 0 20px; /* Padding hai bên */
}

/* --- Header --- */
.header {
    background-color: var(--white-color);
    padding: 20px;
    border-radius: var(--border-radius-md);
    box-shadow: var(--box-shadow-light);
    display: flex;
    flex-wrap: wrap; /* Cho phép wrap trên màn hình nhỏ */
    align-items: center;
    gap: 20px;
    margin-bottom: 25px;
    max-width: 1400px; /* Giới hạn chiều rộng */
    margin-left: auto; /* Căn giữa */
    margin-right: auto; /* Căn giữa */
}

.title-wrapper h1 {
    font-size: 1.8em; /* Giảm nhẹ kích thước */
    color: var(--primary-color);
    text-shadow: none;
    margin: 0; /* Xóa margin mặc định của h1 */
    white-space: nowrap; /* Ngăn không cho tiêu đề xuống dòng */
}

.input-actions-group {
    display: flex;
    flex-wrap: wrap; /* Cho phép wrap */
    gap: 15px;
    align-items: center; /* Căn giữa các item */
    flex-grow: 1; /* Cho phép nhóm này mở rộng */
    justify-content: flex-end; /* Đẩy về bên phải */
}

.input-group {
    display: flex;
    gap: 10px;
    min-width: 250px; /* Đảm bảo đủ rộng */
    flex-grow: 1; /* Cho phép input URL mở rộng */
    max-width: 400px; /* Giới hạn chiều rộng tối đa */
}

.url-input {
    flex-grow: 1;
    padding: 10px 12px;
    border: 1px solid var(--medium-gray);
    border-radius: var(--border-radius-md);
    font-size: 14px;
    transition: border-color var(--transition-speed);
}
.url-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.file-upload-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
}

/* --- Nút Bấm Chung --- */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: var(--border-radius-md);
    cursor: pointer;
    transition: background-color var(--transition-speed), transform var(--transition-speed), box-shadow var(--transition-speed);
    font-weight: 600;
    font-size: 14px;
    text-align: center;
    display: inline-flex; /* Để căn chỉnh icon nếu có */
    align-items: center;
    justify-content: center;
    line-height: 1.5; /* Đảm bảo chiều cao nhất quán */
}
.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.btn:active {
    transform: translateY(0px);
    box-shadow: none;
}

/* Nút Chính (Tải URL, Xử lý TXT, Tạo Biểu đồ) */
.btn-primary {
    background-color: var(--primary-color);
    color: var(--white-color);
}
.btn-primary:hover {
    background-color: #2980b9; /* Màu tối hơn chút */
}

/* Nút Thành Công (Xuất Excel) */
.btn-success {
    background-color: var(--success-color);
    color: var(--white-color);
}
.btn-success:hover {
    background-color: #27ae60;
}

/* Nút Export Ảnh */
.btn-export {
    background-color: var(--info-color);
    color: var(--white-color);
}
.btn-export:hover {
    background-color: #8e44ad;
}

/* Nút Toggle (Ẩn/Hiện) */
.btn-toggle {
    background-color: var(--secondary-color);
    color: var(--white-color);
}
.btn-toggle:hover {
    background-color: #7f8c8d;
}

/* --- File Upload Labels (Giữ nguyên style đẹp sẵn có) --- */
.upload-label {
    display: inline-flex;
    align-items: center;
    padding: 10px 15px; /* Giảm padding chút */
    border-radius: var(--border-radius-md);
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 14px; /* Đồng bộ font size */
}
/* ... (giữ nguyên style .excel-label, .txt-label và ::before) ... */
.excel-label { background: #217346; color: white; border: 1px solid #1a5f38; }
.excel-label:hover { background: #1a5f38; transform: translateY(-1px); }
.excel-label::before { content: "📊"; margin-right: 8px; font-size: 16px; }

.txt-label { background: #e67e22; color: white; border: 1px solid #d35400; }
.txt-label:hover { background: #d35400; transform: translateY(-1px); }
.txt-label::before { content: "📄"; margin-right: 8px; font-size: 16px; }

.file-name {
    margin-left: 10px;
    font-size: 13px; /* Nhỏ hơn chút */
    color: var(--dark-gray);
    font-style: italic;
}
input[type="file"] { /* Ẩn input gốc */
    width: 0.1px;
    height: 0.1px;
    opacity: 0;
    overflow: hidden;
    position: absolute;
    z-index: -1;
}
/* --- Toolbar và Tabs --- */
.toolbar {
    margin: 25px 0;
    display: flex;
    flex-wrap: wrap; /* Cho phép wrap */
    gap: 10px;
    align-items: center;
}

.tab {
    display: flex;
    gap: 5px;
    background: var(--white-color);
    border-radius: var(--border-radius-md);
    padding: 5px;
    box-shadow: var(--box-shadow-light);
    margin-left: auto; /* Đẩy tab sang phải */
}

.tab button { /* Style cho nút trong tab */
    padding: 8px 18px; /* Giảm padding */
    background: none;
    color: var(--text-color);
    border-radius: var(--border-radius-sm); /* Bo góc ít hơn */
    font-weight: 500; /* Giảm độ đậm */
    box-shadow: none; /* Bỏ shadow mặc định của .btn */
}
.tab button:hover {
    background-color: var(--light-gray);
    transform: none; /* Bỏ hiệu ứng transform */
    box-shadow: none;
}
.tab button.active {
    background: var(--primary-color); /* Dùng màu primary */
    color: var(--white-color);
    font-weight: 600; /* Đậm hơn khi active */
}

/* --- Tab Content --- */
.tab-content {
    margin-top: 20px;
    background: var(--white-color);
    border-radius: var(--border-radius-md);
    padding: 20px;
    box-shadow: var(--box-shadow-medium);
    /* Thêm transition để ẩn hiện mượt hơn (nếu muốn) */
    /* transition: opacity 0.3s ease, visibility 0.3s ease; */
}
.tab-content-hidden {
    display: none; /* Class để ẩn tab */
    /* opacity: 0; */
    /* visibility: hidden; */
}

/* --- Bảng Dữ liệu --- */
.table-responsive {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border: 1px solid var(--light-gray); /* Thêm viền nhẹ */
    border-radius: var(--border-radius-md);
    margin-bottom: 1rem;
}
.table-responsive > table {
    min-width: 800px;
    width: 100%;
    border-collapse: collapse; /* Đảm bảo border collapse */
    margin-top: 0; /* Xóa margin top mặc định */
    table-layout: fixed;
}

th, td {
    padding: 12px 15px; /* Tăng padding cho thoáng */
    text-align: center;
    border-bottom: 1px solid var(--light-gray);
    white-space: nowrap; /* Ngăn nội dung cell xuống dòng */
}

th {
    background: #e9edf0; /* Màu nền header nhạt hơn */
    color: var(--text-color); /* Màu chữ tối hơn */
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
    border-bottom-width: 2px; /* Đường kẻ dưới header đậm hơn */
    border-bottom-color: var(--medium-gray);
}

tbody tr:nth-child(even) {
    background-color: #f9fafb; /* Zebra striping */
}
tbody tr:hover {
    background-color: #f0f4f8; /* Hiệu ứng hover */
}

/* Input trong bảng */
.target-input {
    width: 70px;
    padding: 6px 8px;
    border: 1px solid var(--medium-gray);
    border-radius: var(--border-radius-sm);
    text-align: center;
    font-size: 14px;
    transition: border-color var(--transition-speed);
}
.target-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* Footer của bảng (nút cập nhật) */
.table-footer {
    margin-top: 15px;
    text-align: left;
}
.table-footer button { /* Style riêng cho nút này */
    background: var(--warning-color);
    color: var(--white-color);
    padding: 8px 15px;
    font-size: 14px;
}
.table-footer button:hover {
    background: #e67e22; /* Màu tối hơn */
}

/* Style cột cuối (Thiếu/Dư/Bù) */
td:nth-last-child(1), td:nth-last-child(2) {
    font-weight: 600;
    color: var(--danger-color);
}


/* Ẩn cột cuối tab Sufficient */
#sufficientContent .table-responsive > table td:nth-last-child(1),
#sufficientContent .table-responsive > table th:nth-last-child(1) {
    display: none;
}

/* Style cho tab Corrected */
#correctedContent .table-responsive > table {
    border: 1px dashed var(--primary-color); /* Đổi thành dashed */
}
#correctedContent .table-responsive > table td {
    color: var(--dark-gray);
    font-style: italic;
}
#correctedContent .table-responsive > table td:nth-last-child(1),
#correctedContent .table-responsive > table td:nth-last-child(2) {
    font-weight: bold;
    color: var(--danger-color);
    font-style: normal; /* Bỏ italic cho cột này */
}
#correctedContent .table-responsive > table th:nth-last-child(1),
#correctedContent .table-responsive > table th:nth-last-child(2) {
    background-color: var(--warning-color);
    color: var(--white-color);
}

/* --- Biểu đồ --- */
.chart-section { /* Thay thế style inline */
    margin-top: 30px;
    background: var(--white-color);
    border-radius: var(--border-radius-md);
    padding: 25px;
    box-shadow: var(--box-shadow-medium);
}
.chart-section h2 {
    text-align: center;
    margin-top: 0;
    margin-bottom: 25px;
    color: var(--primary-color);
}
.chart-grid { /* Thay thế div flex inline */
    display: grid; /* Dùng grid cho linh hoạt */
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Tự động điều chỉnh cột */
    gap: 30px; /* Khoảng cách giữa các biểu đồ */
    margin-bottom: 20px; /* Khoảng cách trước nút cập nhật */
}
.chart-wrapper { /* Bao bọc canvas */
    /* Không cần set width cố định nữa vì grid xử lý */
    background-color: #fdfdfd; /* Nền nhẹ cho chart */
    padding: 15px;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--light-gray);
}

/* --- Logic Ẩn/Hiện Cột --- */
body.hide-id-column th.id-column,
body.hide-id-column td.id-column { display: none; }
body.hide-quaituan th.quai-tuan-column,
body.hide-quaituan td.quai-tuan-column { display: none; }

/* --- Responsive --- */

/* Màn hình nhỏ hơn (Tablet dọc & Điện thoại lớn) */
@media (max-width: 768px) {
        .main-container {
        padding: 0 15px; /* Giảm padding */
    }
    .header {
        flex-direction: column;
        align-items: stretch; /* Các item chiếm đủ chiều rộng */
        padding: 15px;
    }
    .title-wrapper {
        text-align: center; /* Căn giữa tiêu đề */
    }
    .input-actions-group {
        justify-content: center; /* Căn giữa các control */
    }
    .input-group {
        max-width: none; /* Cho phép input URL rộng hơn */
    }

    .toolbar {
        flex-direction: column;
        align-items: stretch; /* Nút chiếm đủ rộng */
        gap: 10px;
    }
    .tab {
        margin-left: 0; /* Bỏ margin khi xếp dọc */
        width: 100%;
        justify-content: center; /* Căn giữa các nút tab */
    }
    .tab button {
        flex-grow: 1; /* Các nút tab chia đều không gian */
        text-align: center;
    }
    .btn { /* Đảm bảo các nút toolbar chiếm đủ rộng */
        width: 100%;
        box-sizing: border-box;
    }
    .download-btn {
        margin-top: 5px; /* Thêm khoảng cách nhỏ */
    }

    .chart-grid {
        /* Grid tự động xếp thành 1 cột vì minmax(250px, 1fr) */
        gap: 20px; /* Giảm gap */
    }
    .chart-section {
        padding: 20px; /* Giảm padding */
    }
}

/* Màn hình điện thoại nhỏ */
@media (max-width: 480px) {
        .main-container {
        padding: 0 10px;
    }
    .header h1 {
        font-size: 1.6em; /* Giảm nữa */
    }
    .btn {
        padding: 10px 15px; /* Giảm padding nút */
        font-size: 13px;
    }
    .tab button {
        padding: 8px 10px;
    }
    th, td {
        padding: 8px 10px; /* Giảm padding cell */
        font-size: 13px; /* Giảm font chữ bảng */
    }
    .target-input {
        width: 55px; /* Giảm nữa */
        font-size: 13px;
    }
    .chart-section h2 {
        font-size: 1.4em;
    }
}
    </style>
</head>

<body>
    <!-- Header giữ nguyên -->
    <div class="header">
        <div class="title-wrapper">
            <h1>🏹 Quản Lý Săn Quái FvN</h1>
        </div>
        <div class="input-actions-group">
            <div class="input-group">
                <input type="text" id="excelUrl" placeholder="Dán link Google Sheets hoặc URL Excel..." class="url-input">
                <!-- Thêm class 'btn' và 'btn-primary' -->
                <button class="btn btn-primary" onclick="loadExcelFromUrl()">Tải từ URL</button>
            </div>
            <div class="file-upload-controls">
                <div class="file-upload-group">
                    <label class="upload-label excel-label" for="excelFile">
                        Chọn file Excel
                        <span class="file-name" id="excelFileName"></span>
                    </label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls"
                        onchange="document.getElementById('excelFileName').textContent = this.files[0]?.name || ''">
                </div>
                <div class="file-upload-group">
                    <label class="upload-label txt-label" for="txtFile">
                        Chọn file TXT
                        <span class="file-name" id="txtFileName"></span>
                    </label>
                    <input type="file" id="txtFile" accept=".txt"
                        onchange="document.getElementById('txtFileName').textContent = this.files[0]?.name || ''">
                </div>
                <!-- Thêm class 'btn' và 'btn-primary' -->
                <button class="btn btn-primary process-txt-btn" onclick="processTxtFile()">Xử lý TXT</button>
            </div>
        </div>
    </div>

    <!-- Bọc nội dung chính -->
    <div class="main-container">
        <div class="toolbar">
            <!-- Thêm class 'btn' và 'btn-toggle' -->
            <button class="btn btn-toggle" onclick="toggleQuaiTuan()">Ẩn/Hiện Quái Tuần</button>
            <button class="btn btn-toggle" onclick="toggleIdColumn()">Ẩn/Hiện ID</button>
            <!-- Thêm class 'btn' và 'btn-export' -->
            <button class="btn btn-export export-image-btn" onclick="exportToImage()">📸 Xuất Ảnh</button>
            <div class="tab">
                <!-- Thêm class 'btn' cho các nút tab -->
                <button class="btn active" onclick="showTab('missing')">Thiếu (<span id="missingCount">0</span>)</button>
                <button class="btn" onclick="showTab('sufficient')">Đủ/Dư (<span id="sufficientCount">0</span>)</button>
                <button class="btn" onclick="showTab('corrected')">Đã sửa (<span id="correctedCount">0</span>)</button>
            </div>
            <!-- Nút Xuất Excel sẽ được thêm bằng JS, cần đảm bảo nó cũng có class 'btn btn-success' -->
        </div>

        <!-- Xóa style="display: none;" -->
        <div id="missing" class="tab-content">
            <div id="missingContent"></div>
        </div>
        <div id="sufficient" class="tab-content tab-content-hidden">
            <div id="sufficientContent"></div>
        </div>
        <div id="corrected" class="tab-content tab-content-hidden">
            <div id="correctedContent"></div>
        </div>

        <!-- Xóa style inline, thêm class 'chart-section' -->
        <div class="chart-section">
            <h2>📊 Thống Kê Nhanh</h2>
            <!-- Thêm class 'chart-grid' -->
            <div class="chart-grid">
                <!-- Xóa style inline, thêm class 'chart-wrapper' -->
                <div class="chart-wrapper">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="topPlayersChart"></canvas>
                </div>
            </div>
             <!-- Thêm class 'btn' và 'btn-primary' -->
            <button class="btn btn-primary" onclick="renderCharts()" style="margin-top: 15px;">Tạo/Cập nhật Biểu Đồ</button>
        </div>
    </div>

    <script>
        // Khai báo biến lưu dữ liệu
        let statusChartInstance = null;
        let topPlayersChartInstance = null;        
        let originalData = []; // Thêm dòng này
        let processedData = [];
        let showQuaiTuan = true;
        let showIdColumn = true;        
        let currentTab = 'missing';

        // Xử lý hiển thị tên file
        document.getElementById('excelFile').addEventListener('change', function (e) {
            document.getElementById('excelFileName').textContent = this.files[0]?.name || 'Chưa chọn file';
        });

        document.getElementById('txtFile').addEventListener('change', function (e) {
            document.getElementById('txtFileName').textContent = this.files[0]?.name || 'Chưa chọn file';
        });
        // === KẾT THÚC PHẦN THÊM ===

        document.getElementById('excelFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // Cập nhật cả originalData và processedData
                    originalData = processData(jsonData); // Dữ liệu gốc
                    processedData = JSON.parse(JSON.stringify(originalData)); // Bản sao để chỉnh sửa
                    currentTab = 'missing';
                    updateUI();

                } catch (error) {
                    alert('Lỗi đọc file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // Hàm xử lý dữ liệu Excel gốc
        function processExcelData(rawData) {
            const headers = rawData[0].map(h => h.trim().toLowerCase());

            return rawData.slice(1).map(row => {
                return {
                    id: parseInt(row[headers.indexOf("user id")]) || 0,
                    name: row[headers.indexOf("name")] || '',
                    levels: {
                        l1: parseInt(row[headers.indexOf("l1 (hunt)")]) || 0,
                        l2: parseInt(row[headers.indexOf("l2 (hunt)")]) || 0,
                        l3: parseInt(row[headers.indexOf("l3 (hunt)")]) || 0,
                        l4: parseInt(row[headers.indexOf("l4 (hunt)")]) || 0,
                        l5: parseInt(row[headers.indexOf("l5 (hunt)")]) || 0
                    },
                    target: 56, // Giá trị mặc định
                    points: 0,
                    status: 'missing',
                    corrected: false
                };
            }).filter(item => item.id !== 0);
        }

        // Hàm xử lý file TXT
        function processTxtFile() {
            const txtFile = document.getElementById('txtFile').files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const userIds = e.target.result.split(',').map(id => id.trim());

                // Chỉ cập nhật processedData, giữ nguyên originalData
                userIds.forEach(uid => {
                    const user = processedData.find(item => String(item.id) === uid);
                    if (user && user.points < user.target) {
                        const needed = user.target - user.points;
                        adjustLevels(user, needed);
                        user.corrected = true;
                    }
                });

                updateUI();
            };
            reader.readAsText(txtFile);
        }

        /* ▼▼▼ Thêm hàm xuất ảnh ở đây ▼▼▼ */
        async function exportToImage() {
    if (!processedData.length) {
        alert("Vui lòng tải file Excel trước!");
        return;
    }

    const contentDivId = `${currentTab}Content`;
    const elementToCapture = document.getElementById(contentDivId);

    if (!elementToCapture) {
        alert("Không tìm thấy nội dung để chụp ảnh.");
        return;
    }

    // Kiểm tra xem có bảng bên trong không
    const tableElement = elementToCapture.querySelector('table');
    if (!tableElement) {
        alert(`Không tìm thấy bảng dữ liệu trong tab "${currentTab}" để xuất ảnh.`);
        return;
    }

    // Hiển thị thông báo đang xử lý (tùy chọn)
    const originalButtonText = document.querySelector('.export-image-btn').textContent;
    document.querySelector('.export-image-btn').textContent = '📸 Đang xử lý...';
    document.querySelector('.export-image-btn').disabled = true;


    // Thêm độ trễ nhỏ (ví dụ: 100ms) trước khi chụp
    setTimeout(async () => {
        try {
            console.log("Bắt đầu chụp ảnh phần tử:", contentDivId);
            const canvas = await html2canvas(elementToCapture, {
                scale: 1.5,
                useCORS: true,
                logging: false, // Bật true để debug nếu cần
                // Đảm bảo chụp cả phần bị cuộn ngang nếu có
                scrollX: 0,
                scrollY: -window.scrollY, // Cần thiết nếu trang có cuộn dọc
                windowWidth: elementToCapture.scrollWidth, // Chụp theo chiều rộng nội dung
                windowHeight: elementToCapture.scrollHeight // Chụp theo chiều cao nội dung
            });
            console.log("Đã tạo canvas");

            const imageDataUrl = canvas.toDataURL('image/png');

            // Mở ảnh trong tab mới (tốt hơn cho iOS)
            const newWindow = window.open();
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                        <head><title>Báo cáo ${currentTab}</title></head>
                        <body style="margin:0;">
                            <img src="${imageDataUrl}" alt="Báo cáo" style="max-width: 100%; display: block;">
                        </body>
                    </html>`);
                // newWindow.document.title = `BaoCao_${currentTab}_${new Date().toISOString().slice(0, 10)}`; // Đặt title trong head tốt hơn
            } else {
                alert("Không thể mở tab mới. Vui lòng kiểm tra cài đặt chặn pop-up của trình duyệt và thử lại.");
            }

        } catch (error) {
            console.error('Lỗi xuất ảnh:', error);
            alert(`Xuất ảnh thất bại! Lỗi: ${error.message}. Vui lòng thử lại hoặc kiểm tra console.`);
        } finally {
            // Khôi phục trạng thái nút
            document.querySelector('.export-image-btn').textContent = originalButtonText;
            document.querySelector('.export-image-btn').disabled = false;
            console.log("Hoàn tất xử lý xuất ảnh.");
        }
    }, 100); // Độ trễ 100 mili giây
}


        /* ▲▲▲ Kết thúc phần thêm hàm ▲▲▲ */

        function processData(data) {
            const result = [];
            if (data.length < 2) return result;

            const headers = data[0].map(h => h.trim().toLowerCase());
            const colIndex = {
                userId: headers.indexOf("user id"),
                name: headers.indexOf("name"),
                l1: headers.indexOf("l1 (hunt)"),
                l2: headers.indexOf("l2 (hunt)"),
                l3: headers.indexOf("l3 (hunt)"),
                l4: headers.indexOf("l4 (hunt)"),
                l5: headers.indexOf("l5 (hunt)")
            };

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                const item = {
                    id: parseInt(row[colIndex.userId]) || 0,
                    name: row[colIndex.name] || '',
                    levels: {
                        l1: parseInt(row[colIndex.l1]) || 0,
                        l2: parseInt(row[colIndex.l2]) || 0,
                        l3: parseInt(row[colIndex.l3]) || 0,
                        l4: parseInt(row[colIndex.l4]) || 0,
                        l5: parseInt(row[colIndex.l5]) || 0
                    },
                    target: 56,
                    status: 'missing'
                };

                calculatePoints(item);
                result.push(item);
            }

            return result.filter(item => item.id !== 0);
        }

        function calculatePoints(item) {
            item.points = item.levels.l2 +
                (item.levels.l3 * 4) +
                (item.levels.l4 * 16) +
                (item.levels.l5 * 32);
            updateStatus(item);
        }

        function updateStatus(item) {
            const diff = item.points - item.target;
            item.status = diff >= 0 ? (diff > 0 ? 'excess' : 'sufficient') : 'missing';
        }
function renderCharts() {
    if (!processedData || processedData.length === 0) {
        alert("Chưa có dữ liệu để vẽ biểu đồ. Vui lòng tải file Excel trước.");
        return;
    }

    // --- Dữ liệu cho Biểu đồ Trạng thái (Pie Chart) ---
    const statusCounts = {
        missing: processedData.filter(item => item.status === 'missing').length,
        sufficient: processedData.filter(item => item.status === 'sufficient').length,
        excess: processedData.filter(item => item.status === 'excess').length,
    };

    const statusCtx = document.getElementById('statusChart').getContext('2d');

    // Hủy biểu đồ cũ nếu tồn tại
    if (statusChartInstance) {
        statusChartInstance.destroy();
    }

    statusChartInstance = new Chart(statusCtx, {
        type: 'doughnut', // Hoặc 'pie'
        data: {
            labels: ['Thiếu', 'Đủ', 'Dư'],
            datasets: [{
                label: 'Phân loại trạng thái',
                data: [statusCounts.missing, statusCounts.sufficient, statusCounts.excess],
                backgroundColor: [
                    'rgb(241, 196, 15)', // Warning color (Thiếu)
                    'rgb(46, 204, 113)', // Success color (Đủ)
                    'rgb(231, 76, 60)'   // Danger color (Dư)
                ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'Tỷ lệ trạng thái săn quái'
                }
            }
        }
    });

    // --- Dữ liệu cho Biểu đồ Top Người Chơi (Bar Chart) ---
    const topN = 10; // Lấy top 10 người
    const sortedPlayers = [...processedData]
                          .sort((a, b) => b.points - a.points)
                          .slice(0, topN);

    const topPlayersCtx = document.getElementById('topPlayersChart').getContext('2d');

     // Hủy biểu đồ cũ nếu tồn tại
    if (topPlayersChartInstance) {
        topPlayersChartInstance.destroy();
    }

    topPlayersChartInstance = new Chart(topPlayersCtx, {
        type: 'bar',
        data: {
            labels: sortedPlayers.map(p => p.name.substring(0, 15) + (p.name.length > 15 ? '...' : '')), // Cắt ngắn tên nếu quá dài
            datasets: [{
                label: `Top ${topN} người chơi theo Points Hunt`,
                data: sortedPlayers.map(p => p.points),
                backgroundColor: 'rgba(52, 152, 219, 0.7)', // Primary color with transparency
                borderColor: 'rgb(52, 152, 219)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y', // Hiển thị thanh ngang để dễ đọc tên
            responsive: true,
            scales: {
                x: {
                    beginAtZero: true
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: `Top ${topN} người chơi điểm cao nhất`
                },
                legend: {
                    display: false // Có thể ẩn chú thích nếu chỉ có 1 dataset
                }
            }
        }
    });
}

function updateUI() {
    updateCounts();
    renderTable(currentTab);

    // Chỉ xóa nút Excel (class 'download-btn')
    document.querySelector('.download-btn')?.remove();

    createDownloadButton(); // Tạo lại nút Excel mới

    // Gọi hàm vẽ biểu đồ (nếu có dữ liệu)
    if (processedData && processedData.length > 0) {
         // Có thể thêm độ trễ nhỏ để đảm bảo DOM cập nhật xong
         // setTimeout(renderCharts, 100);
         // Hoặc gọi trực tiếp nếu không gặp vấn đề
         renderCharts();
    }
}


        function updateCounts() {
            const counts = {
                missing: processedData.filter(item => item.status === 'missing').length,
                sufficient: processedData.filter(item => item.status === 'sufficient').length,
                excess: processedData.filter(item => item.status === 'excess').length,
                corrected: processedData.filter(item => item.corrected).length
            };

            document.getElementById('missingCount').textContent = counts.missing;
            document.getElementById('sufficientCount').textContent = counts.sufficient + counts.excess;
            document.getElementById('correctedCount').textContent = counts.corrected;
        }

        // Cập nhật hàm render cho tab "Đã sửa"
        // Trong hàm renderTable, xóa logic xử lý tab Top 3
        function renderTable(tabId) {
    let content = '';
    switch (tabId) {
        case 'missing':
            content = generateTable(processedData.filter(item => item.status === 'missing'), 'missing');
            break;
        case 'sufficient':
            const sufficientData = [...processedData]
                .filter(item => item.status !== 'missing')
                .sort((a, b) => b.points - a.points);
            content = generateTable(sufficientData, 'sufficient');
            break;
        case 'corrected':
            if (!originalData || originalData.length === 0) {
                content = '<p class="empty">Chưa có dữ liệu gốc</p>';
            } else {
                const correctedIds = processedData.filter(item => item.corrected).map(item => item.id);
                const correctedOriginalData = originalData.filter(item => correctedIds.includes(item.id));
                content = generateTable(correctedOriginalData, 'corrected');
            }
            break;
    }
    document.getElementById(`${tabId}Content`).innerHTML = content;
}

        // Sửa lại hàm generateTable chỉ dùng cho các tab thường
        function generateTable(data, tabId) {
            if (!data || data.length === 0) return '<p class="empty">Không có dữ liệu</p>';
        
            const showCheckbox = tabId === 'missing';
        
            // Bọc bảng trong div.table-responsive
            return `
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            ${showCheckbox ? '<th></th>' : ''}
                            <th class="id-column">ID</th>
                            <th>Tên</th>
                            <th>1</th>
                            <th>2</th>
                            <th>3</th>
                            <th>4</th>
                            <th>5</th>
                            <th class="quai-tuan-column">Quái Tuần</th>
                            <th>Points Hunt</th>
                            <th>${tabId === 'sufficient' ? 'Dư' : 'Thiếu'}</th>
                            ${tabId !== 'sufficient' ? '<th>Bù</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr>
                                ${showCheckbox ? `
                                    <td><input type="checkbox" data-id="${item.id}"></td>
                                ` : ''}
                                <td class="id-column">${item.id}</td>
                                <td>${item.name}</td>
                                <td>${item.levels.l1}</td>
                                <td>${item.levels.l2}</td>
                                <td>${item.levels.l3}</td>
                                <td>${item.levels.l4}</td>
                                <td>${item.levels.l5}</td>
                                <td class="quai-tuan-column">
                                    <input type="number"
                                           value="${item.target}"
                                           data-id="${item.id}"
                                           class="target-input">
                                </td>
                                <td>${item.points}</td>
                                <td>${tabId === 'sufficient' ?
                        Math.max(item.points - item.target, 0) :
                        item.target - item.points}
                                </td>
                                ${tabId !== 'sufficient' ? `
                                    <td>${(item.target - item.points) * 2}</td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            ${showCheckbox ? `
                <div class="table-footer">
                    <button onclick="processCorrections()">Cập nhật mục chọn</button>
                </div>
            ` : ''}
        `;
        }
        
        

        function getStatusText(item) {
            const diff = item.points - item.target;
            if (diff < 0) return `Thiếu ${-diff}`;
            if (diff === 0) return 'Đủ';
            return `Dư ${diff}`;
        }

        

        // Thêm hàm tính level cao nhất
        function calculateHighestLevel(levels) {
            const levelValues = [levels.l2, levels.l3, levels.l4, levels.l5];
            let maxLevel = 2;
            levelValues.forEach((val, idx) => {
                if (val > 0) maxLevel = idx + 2;
            });
            return maxLevel;
        }

        // Cập nhật hàm showTab để dùng class thay vì style inline
            function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('tab-content-hidden'); // Thêm class ẩn
                el.style.display = 'none'; // Vẫn giữ display none để đảm bảo ẩn ban đầu
            });
            const activeTabContent = document.getElementById(tabId);
            activeTabContent.classList.remove('tab-content-hidden'); // Xóa class ẩn
            activeTabContent.style.display = 'block'; // Hiển thị

            // Cập nhật class 'active' cho nút tab
            document.querySelectorAll('.tab button').forEach(btn => btn.classList.remove('active'));
            // Tìm nút tương ứng và thêm class active (cần đảm bảo onclick có cách lấy đúng nút)
            // Ví dụ đơn giản: tìm theo nội dung text hoặc thêm data-tab attribute
             document.querySelector(`.tab button[onclick="showTab('${tabId}')"]`).classList.add('active');


            currentTab = tabId;
            renderTable(tabId);
        }

        function toggleQuaiTuan() {
            showQuaiTuan = !showQuaiTuan;
            // Thêm/xóa class 'hide-quaituan' trên thẻ body
            document.body.classList.toggle('hide-quaituan', !showQuaiTuan);
            // Không cần render lại bảng
        }
        
        function toggleIdColumn() {
            showIdColumn = !showIdColumn;
            // Thêm/xóa class 'hide-id-column' trên thẻ body
            document.body.classList.toggle('hide-id-column', !showIdColumn);
            // Không cần render lại bảng vì CSS sẽ xử lý việc ẩn/hiện
        }
        
        // Hàm xử lý cập nhật mục chọn
        function processCorrections() {
            const selectedIds = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(checkbox => parseInt(checkbox.dataset.id));

            processedData.forEach(item => {
                if (selectedIds.includes(item.id)) {
                    const needed = item.target - item.points;
                    if (needed > 0) {
                        adjustLevels(item, needed);
                        item.corrected = true;
                    }
                }
            });

            updateUI();
        }

        function adjustLevels(item, needed) {
            let remaining = needed;
            const add = {
                l5: Math.min(Math.floor(remaining / 32)),
                l4: 0, l3: 0, l2: 0
            };

            remaining %= 32;
            add.l4 = Math.min(Math.floor(remaining / 16));
            remaining %= 16;
            add.l3 = Math.min(Math.floor(remaining / 4));
            remaining %= 4;
            add.l2 = remaining;

            item.levels.l5 += add.l5;
            item.levels.l4 += add.l4;
            item.levels.l3 += add.l3;
            item.levels.l2 += add.l2;

            calculatePoints(item);
        }
         // Cập nhật hàm createDownloadButton để thêm class
         function createDownloadButton() {
            // Xóa nút cũ trước khi tạo mới (để tránh trùng lặp)
            document.querySelector('.download-btn')?.remove();

            const btn = document.createElement('button');
            // Thêm các class cần thiết
            btn.className = 'btn btn-success download-btn'; // Class chung và class riêng
            btn.textContent = '📥 Xuất Excel';
            btn.onclick = exportToExcel;
            document.querySelector('.toolbar').appendChild(btn);
        }
        // Gọi showTab ban đầu để ẩn các tab không active
        document.addEventListener('DOMContentLoaded', () => {
             showTab('missing'); // Hiển thị tab mặc định
        });

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const cleanSheetName = (name) => name.replace(/[\\/:*?[\]]/g, '-');

            // Định nghĩa dữ liệu cho từng sheet
            const sheets = {
                "Thiếu": {
                    data: processedData.filter(item => item.status === 'missing'),
                    columns: ["User ID", "Name", "L1 (Hunt)", "L2 (Hunt)", "L3 (Hunt)", "L4 (Hunt)", "L5 (Hunt)", "Quái Tuần", "Points Hunt", "Thiếu", "Bù"]
                },
                "Đủ-Dư": {
                    data: processedData.filter(item => item.status !== 'missing'),
                    columns: ["User ID", "Name", "L1 (Hunt)", "L2 (Hunt)", "L3 (Hunt)", "L4 (Hunt)", "L5 (Hunt)", "Quái Tuần", "Points Hunt", "Dư"]
                },
                "Đã sửa": {
                    data: originalData.filter(item =>
                        processedData.some(p => p.id === item.id && p.corrected)
                    ),
                    columns: ["User ID", "Name", "L1 (Hunt)", "L2 (Hunt)", "L3 (Hunt)", "L4 (Hunt)", "L5 (Hunt)", "Quái Tuần", "Points Hunt", "Thiếu", "Bù"]
                },
            };

            // Tạo từng sheet và thêm vào workbook
            Object.entries(sheets).forEach(([sheetName, config]) => {
                const wsData = [
                    config.columns, // Header
                    ...config.data.map(item => {
                        const row = {
                            "User ID": item.id,
                            "Name": item.name,
                            "L1 (Hunt)": item.levels.l1,
                            "L2 (Hunt)": item.levels.l2,
                            "L3 (Hunt)": item.levels.l3,
                            "L4 (Hunt)": item.levels.l4,
                            "L5 (Hunt)": item.levels.l5,
                            "Quái Tuần": item.target,
                            "Points Hunt": item.points,
                            "Thiếu": item.target - item.points,
                            "Bù": (item.target - item.points) * 2,
                            "Dư": Math.max(item.points - item.target, 0),
                            "Cấp độ cao nhất": "L" + calculateHighestLevel(item.levels)
                        };

                        return config.columns.map(col => row[col]);
                    })
                ];

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, cleanSheetName(sheetName));
            });

            XLSX.writeFile(wb, 'BaoCaoSănQuái.xlsx');
        }
        async function loadExcelFromUrl() {
    const rawUrl = document.getElementById('excelUrl').value.trim();
    console.log("URL gốc:", rawUrl); // Log URL gốc

    if (!rawUrl) {
        alert("Vui lòng nhập URL Google Sheets!");
        return;
    }

    // Hiển thị thông báo đang xử lý (tùy chọn)
    // Ví dụ: document.body.style.cursor = 'wait';

    try {
        // Chuyển đổi URL
        let finalUrl = rawUrl
            .replace(/\/edit\?.*$/, '/export')
            .replace(/#gid=.*/, '')
            + '?format=xlsx';
        console.log("URL đã chuyển đổi:", finalUrl); // Log URL đã chuyển đổi

        // Sử dụng proxy
        const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
        const fetchUrl = proxyUrl + encodeURIComponent(finalUrl);
        console.log("URL Fetch qua Proxy:", fetchUrl); // Log URL sẽ fetch

        const response = await fetch(fetchUrl, {
            // Bỏ User-Agent để thử nghiệm, Safari có thể tự xử lý tốt hơn
            // headers: {
            //     'User-Agent': 'Mozilla/5.0'
            // }
            // Có thể thêm timeout nếu cần
            // signal: AbortSignal.timeout(30000) // Timeout 30 giây
        });
        console.log("Trạng thái phản hồi:", response.status, response.statusText); // Log trạng thái

        if (!response.ok) {
            // Cố gắng đọc nội dung lỗi nếu có
            let errorBody = await response.text().catch(() => 'Không thể đọc nội dung lỗi');
            console.error("Nội dung lỗi từ proxy/server:", errorBody);
            throw new Error(`Lỗi HTTP: ${response.status} ${response.statusText}`);
        }

        // Xử lý dữ liệu
        console.log("Đang xử lý dữ liệu ArrayBuffer...");
        const arrayBuffer = await response.arrayBuffer();
        console.log("Đã nhận ArrayBuffer, kích thước:", arrayBuffer.byteLength);
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        console.log("Đã phân tích dữ liệu JSON từ Excel.");

        // Cập nhật cả originalData và processedData
        originalData = processData(jsonData); // Dữ liệu gốc
        processedData = JSON.parse(JSON.stringify(originalData)); // Bản sao để chỉnh sửa
        currentTab = 'missing'; // Reset về tab mặc định
        updateUI();
        alert("Tải file thành công!");

    } catch (error) {
        console.error("Chi tiết lỗi khi tải URL:", error); // Log lỗi chi tiết
        alert(`Lỗi tải URL: ${error.message || "Kiểm tra lại URL, kết nối mạng hoặc thử lại sau."}`);
    } finally {
        // Ẩn thông báo đang xử lý (nếu có)
        // Ví dụ: document.body.style.cursor = 'default';
    }
}


        // Hàm kiểm tra URL hợp lệ
        function isValidExcelUrl(url) {
            // Cho phép cả URL thông thường và Google Sheets
            return /(\.xlsx?$)|(docs\.google\.com\/spreadsheets\/d\/)/i.test(url);
        }

        // Hàm xử lý thay đổi giá trị Quái Tuần
        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('target-input')) {
                const id = parseInt(e.target.dataset.id);
                const newTarget = parseInt(e.target.value) || 56;

                const user = processedData.find(item => item.id === id);
                if (user) {
                    user.target = newTarget;
                    calculatePoints(user);
                    updateUI();
                }
            }
        });

    </script>
</body>
</html>