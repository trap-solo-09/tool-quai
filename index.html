<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá Th·ªëng Qu·∫£n L√Ω SƒÉn Qu√°i</title>
    <!-- Th√™m v√†o ph·∫ßn head -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js">         
    </script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script>    
    <style>
/* --- Bi·∫øn v√† Thi·∫øt l·∫≠p C∆° b·∫£n --- */
:root {
    --primary-color: #3498db;
    --success-color: #2ecc71;
    --warning-color: #f1c40f;
    --danger-color: #e74c3c;
    --info-color: #9b59b6; /* M√†u cho n√∫t export ·∫£nh */
    --secondary-color: #95a5a6; /* M√†u cho n√∫t toggle */
    --light-gray: #ecf0f1;
    --medium-gray: #bdc3c7;
    --dark-gray: #7f8c8d;
    --text-color: #34495e;
    --bg-color: #f4f7f9; /* N·ªÅn h∆°i x√°m nh·∫π */
    --white-color: #ffffff;
    --border-radius-sm: 4px;
    --border-radius-md: 8px;
    --box-shadow-light: 0 2px 5px rgba(0, 0, 0, 0.08);
    --box-shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
    --transition-speed: 0.2s;
}

body {
    font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    margin: 0; /* X√≥a margin m·∫∑c ƒë·ªãnh */
    background-color: var(--bg-color);
    color: var(--text-color);
    line-height: 1.6;
}

/* --- Container Ch√≠nh --- */
.main-container {
    max-width: 1400px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông t·ªëi ƒëa */
    margin: 20px auto; /* CƒÉn gi·ªØa v√† t·∫°o kho·∫£ng c√°ch tr√™n/d∆∞·ªõi */
    padding: 0 20px; /* Padding hai b√™n */
}

/* --- Header --- */
.header {
    background-color: var(--white-color);
    padding: 20px;
    border-radius: var(--border-radius-md);
    box-shadow: var(--box-shadow-light);
    display: flex;
    flex-wrap: wrap; /* Cho ph√©p wrap tr√™n m√†n h√¨nh nh·ªè */
    align-items: center;
    gap: 20px;
    margin-bottom: 25px;
    max-width: 1400px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông */
    margin-left: auto; /* CƒÉn gi·ªØa */
    margin-right: auto; /* CƒÉn gi·ªØa */
}

.title-wrapper h1 {
    font-size: 1.8em; /* Gi·∫£m nh·∫π k√≠ch th∆∞·ªõc */
    color: var(--primary-color);
    text-shadow: none;
    margin: 0; /* X√≥a margin m·∫∑c ƒë·ªãnh c·ªßa h1 */
    white-space: nowrap; /* NgƒÉn kh√¥ng cho ti√™u ƒë·ªÅ xu·ªëng d√≤ng */
}

.input-actions-group {
    display: flex;
    flex-wrap: wrap; /* Cho ph√©p wrap */
    gap: 15px;
    align-items: center; /* CƒÉn gi·ªØa c√°c item */
    flex-grow: 1; /* Cho ph√©p nh√≥m n√†y m·ªü r·ªông */
    justify-content: flex-end; /* ƒê·∫©y v·ªÅ b√™n ph·∫£i */
}

.input-group {
    display: flex;
    gap: 10px;
    min-width: 250px; /* ƒê·∫£m b·∫£o ƒë·ªß r·ªông */
    flex-grow: 1; /* Cho ph√©p input URL m·ªü r·ªông */
    max-width: 400px; /* Gi·ªõi h·∫°n chi·ªÅu r·ªông t·ªëi ƒëa */
}

.url-input {
    flex-grow: 1;
    padding: 10px 12px;
    border: 1px solid var(--medium-gray);
    border-radius: var(--border-radius-md);
    font-size: 14px;
    transition: border-color var(--transition-speed);
}
.url-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
}

.file-upload-controls {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    align-items: center;
}

/* --- N√∫t B·∫•m Chung --- */
.btn {
    padding: 10px 20px;
    border: none;
    border-radius: var(--border-radius-md);
    cursor: pointer;
    transition: background-color var(--transition-speed), transform var(--transition-speed), box-shadow var(--transition-speed);
    font-weight: 600;
    font-size: 14px;
    text-align: center;
    display: inline-flex; /* ƒê·ªÉ cƒÉn ch·ªânh icon n·∫øu c√≥ */
    align-items: center;
    justify-content: center;
    line-height: 1.5; /* ƒê·∫£m b·∫£o chi·ªÅu cao nh·∫•t qu√°n */
}
.btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.btn:active {
    transform: translateY(0px);
    box-shadow: none;
}

/* N√∫t Ch√≠nh (T·∫£i URL, X·ª≠ l√Ω TXT, T·∫°o Bi·ªÉu ƒë·ªì) */
.btn-primary {
    background-color: var(--primary-color);
    color: var(--white-color);
}
.btn-primary:hover {
    background-color: #2980b9; /* M√†u t·ªëi h∆°n ch√∫t */
}

/* N√∫t Th√†nh C√¥ng (Xu·∫•t Excel) */
.btn-success {
    background-color: var(--success-color);
    color: var(--white-color);
}
.btn-success:hover {
    background-color: #27ae60;
}

/* N√∫t Export ·∫¢nh */
.btn-export {
    background-color: var(--info-color);
    color: var(--white-color);
}
.btn-export:hover {
    background-color: #8e44ad;
}

/* N√∫t Toggle (·∫®n/Hi·ªán) */
.btn-toggle {
    background-color: var(--secondary-color);
    color: var(--white-color);
}
.btn-toggle:hover {
    background-color: #7f8c8d;
}

/* --- File Upload Labels (Gi·ªØ nguy√™n style ƒë·∫πp s·∫µn c√≥) --- */
.upload-label {
    display: inline-flex;
    align-items: center;
    padding: 10px 15px; /* Gi·∫£m padding ch√∫t */
    border-radius: var(--border-radius-md);
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: 500;
    font-size: 14px; /* ƒê·ªìng b·ªô font size */
}
/* ... (gi·ªØ nguy√™n style .excel-label, .txt-label v√† ::before) ... */
.excel-label { background: #217346; color: white; border: 1px solid #1a5f38; }
.excel-label:hover { background: #1a5f38; transform: translateY(-1px); }
.excel-label::before { content: "üìä"; margin-right: 8px; font-size: 16px; }

.txt-label { background: #e67e22; color: white; border: 1px solid #d35400; }
.txt-label:hover { background: #d35400; transform: translateY(-1px); }
.txt-label::before { content: "üìÑ"; margin-right: 8px; font-size: 16px; }

.file-name {
    margin-left: 10px;
    font-size: 13px; /* Nh·ªè h∆°n ch√∫t */
    color: var(--dark-gray);
    font-style: italic;
}
input[type="file"] { /* ·∫®n input g·ªëc */
    width: 0.1px;
    height: 0.1px;
    opacity: 0;
    overflow: hidden;
    position: absolute;
    z-index: -1;
}
/* --- Toolbar v√† Tabs --- */
.toolbar {
    margin: 25px 0;
    display: flex;
    flex-wrap: wrap; /* Cho ph√©p wrap */
    gap: 10px;
    align-items: center;
}

.tab {
    display: flex;
    gap: 5px;
    background: var(--white-color);
    border-radius: var(--border-radius-md);
    padding: 5px;
    box-shadow: var(--box-shadow-light);
    margin-left: auto; /* ƒê·∫©y tab sang ph·∫£i */
}

.tab button { /* Style cho n√∫t trong tab */
    padding: 8px 18px; /* Gi·∫£m padding */
    background: none;
    color: var(--text-color);
    border-radius: var(--border-radius-sm); /* Bo g√≥c √≠t h∆°n */
    font-weight: 500; /* Gi·∫£m ƒë·ªô ƒë·∫≠m */
    box-shadow: none; /* B·ªè shadow m·∫∑c ƒë·ªãnh c·ªßa .btn */
}
.tab button:hover {
    background-color: var(--light-gray);
    transform: none; /* B·ªè hi·ªáu ·ª©ng transform */
    box-shadow: none;
}
.tab button.active {
    background: var(--primary-color); /* D√πng m√†u primary */
    color: var(--white-color);
    font-weight: 600; /* ƒê·∫≠m h∆°n khi active */
}

/* --- Tab Content --- */
.tab-content {
    margin-top: 20px;
    background: var(--white-color);
    border-radius: var(--border-radius-md);
    padding: 20px;
    box-shadow: var(--box-shadow-medium);
    /* Th√™m transition ƒë·ªÉ ·∫©n hi·ªán m∆∞·ª£t h∆°n (n·∫øu mu·ªën) */
    /* transition: opacity 0.3s ease, visibility 0.3s ease; */
}
.tab-content-hidden {
    display: none; /* Class ƒë·ªÉ ·∫©n tab */
    /* opacity: 0; */
    /* visibility: hidden; */
}

/* --- B·∫£ng D·ªØ li·ªáu --- */
.table-responsive {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    border: 1px solid var(--light-gray); /* Th√™m vi·ªÅn nh·∫π */
    border-radius: var(--border-radius-md);
    margin-bottom: 1rem;
}
.table-responsive > table {
    min-width: 800px;
    width: 100%;
    border-collapse: collapse; /* ƒê·∫£m b·∫£o border collapse */
    margin-top: 0; /* X√≥a margin top m·∫∑c ƒë·ªãnh */
    table-layout: fixed;
}

th, td {
    padding: 12px 15px; /* TƒÉng padding cho tho√°ng */
    text-align: center;
    border-bottom: 1px solid var(--light-gray);
    white-space: nowrap; /* NgƒÉn n·ªôi dung cell xu·ªëng d√≤ng */
}

th {
    background: #e9edf0; /* M√†u n·ªÅn header nh·∫°t h∆°n */
    color: var(--text-color); /* M√†u ch·ªØ t·ªëi h∆°n */
    font-weight: 600;
    position: sticky;
    top: 0;
    z-index: 1;
    border-bottom-width: 2px; /* ƒê∆∞·ªùng k·∫ª d∆∞·ªõi header ƒë·∫≠m h∆°n */
    border-bottom-color: var(--medium-gray);
}

tbody tr:nth-child(even) {
    background-color: #f9fafb; /* Zebra striping */
}
tbody tr:hover {
    background-color: #f0f4f8; /* Hi·ªáu ·ª©ng hover */
}

/* Input trong b·∫£ng */
.target-input {
    width: 70px;
    padding: 6px 8px;
    border: 1px solid var(--medium-gray);
    border-radius: var(--border-radius-sm);
    text-align: center;
    font-size: 14px;
    transition: border-color var(--transition-speed);
}
.target-input:focus {
    outline: none;
    border-color: var(--primary-color);
}

/* Footer c·ªßa b·∫£ng (n√∫t c·∫≠p nh·∫≠t) */
.table-footer {
    margin-top: 15px;
    text-align: left;
}
.table-footer button { /* Style ri√™ng cho n√∫t n√†y */
    background: var(--warning-color);
    color: var(--white-color);
    padding: 8px 15px;
    font-size: 14px;
}
.table-footer button:hover {
    background: #e67e22; /* M√†u t·ªëi h∆°n */
}

/* Style c·ªôt cu·ªëi (Thi·∫øu/D∆∞/B√π) */
td:nth-last-child(1), td:nth-last-child(2) {
    font-weight: 600;
    color: var(--danger-color);
}


/* ·∫®n c·ªôt cu·ªëi tab Sufficient */
#sufficientContent .table-responsive > table td:nth-last-child(1),
#sufficientContent .table-responsive > table th:nth-last-child(1) {
    display: none;
}

/* Style cho tab Corrected */
#correctedContent .table-responsive > table {
    border: 1px dashed var(--primary-color); /* ƒê·ªïi th√†nh dashed */
}
#correctedContent .table-responsive > table td {
    color: var(--dark-gray);
    font-style: italic;
}
#correctedContent .table-responsive > table td:nth-last-child(1),
#correctedContent .table-responsive > table td:nth-last-child(2) {
    font-weight: bold;
    color: var(--danger-color);
    font-style: normal; /* B·ªè italic cho c·ªôt n√†y */
}
#correctedContent .table-responsive > table th:nth-last-child(1),
#correctedContent .table-responsive > table th:nth-last-child(2) {
    background-color: var(--warning-color);
    color: var(--white-color);
}

/* --- Bi·ªÉu ƒë·ªì --- */
.chart-section { /* Thay th·∫ø style inline */
    margin-top: 30px;
    background: var(--white-color);
    border-radius: var(--border-radius-md);
    padding: 25px;
    box-shadow: var(--box-shadow-medium);
}
.chart-section h2 {
    text-align: center;
    margin-top: 0;
    margin-bottom: 25px;
    color: var(--primary-color);
}
.chart-grid { /* Thay th·∫ø div flex inline */
    display: grid; /* D√πng grid cho linh ho·∫°t */
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* T·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh c·ªôt */
    gap: 30px; /* Kho·∫£ng c√°ch gi·ªØa c√°c bi·ªÉu ƒë·ªì */
    margin-bottom: 20px; /* Kho·∫£ng c√°ch tr∆∞·ªõc n√∫t c·∫≠p nh·∫≠t */
}
.chart-wrapper { /* Bao b·ªçc canvas */
    /* Kh√¥ng c·∫ßn set width c·ªë ƒë·ªãnh n·ªØa v√¨ grid x·ª≠ l√Ω */
    background-color: #fdfdfd; /* N·ªÅn nh·∫π cho chart */
    padding: 15px;
    border-radius: var(--border-radius-sm);
    border: 1px solid var(--light-gray);
}

/* --- Logic ·∫®n/Hi·ªán C·ªôt --- */
body.hide-id-column th.id-column,
body.hide-id-column td.id-column { display: none; }
body.hide-quaituan th.quai-tuan-column,
body.hide-quaituan td.quai-tuan-column { display: none; }

/* --- Responsive --- */

/* M√†n h√¨nh nh·ªè h∆°n (Tablet d·ªçc & ƒêi·ªán tho·∫°i l·ªõn) */
@media (max-width: 768px) {
        .main-container {
        padding: 0 15px; /* Gi·∫£m padding */
    }
    .header {
        flex-direction: column;
        align-items: stretch; /* C√°c item chi·∫øm ƒë·ªß chi·ªÅu r·ªông */
        padding: 15px;
    }
    .title-wrapper {
        text-align: center; /* CƒÉn gi·ªØa ti√™u ƒë·ªÅ */
    }
    .input-actions-group {
        justify-content: center; /* CƒÉn gi·ªØa c√°c control */
    }
    .input-group {
        max-width: none; /* Cho ph√©p input URL r·ªông h∆°n */
    }

    .toolbar {
        flex-direction: column;
        align-items: stretch; /* N√∫t chi·∫øm ƒë·ªß r·ªông */
        gap: 10px;
    }
    .tab {
        margin-left: 0; /* B·ªè margin khi x·∫øp d·ªçc */
        width: 100%;
        justify-content: center; /* CƒÉn gi·ªØa c√°c n√∫t tab */
    }
    .tab button {
        flex-grow: 1; /* C√°c n√∫t tab chia ƒë·ªÅu kh√¥ng gian */
        text-align: center;
    }
    .btn { /* ƒê·∫£m b·∫£o c√°c n√∫t toolbar chi·∫øm ƒë·ªß r·ªông */
        width: 100%;
        box-sizing: border-box;
    }
    .download-btn {
        margin-top: 5px; /* Th√™m kho·∫£ng c√°ch nh·ªè */
    }

    .chart-grid {
        /* Grid t·ª± ƒë·ªông x·∫øp th√†nh 1 c·ªôt v√¨ minmax(250px, 1fr) */
        gap: 20px; /* Gi·∫£m gap */
    }
    .chart-section {
        padding: 20px; /* Gi·∫£m padding */
    }
}

/* M√†n h√¨nh ƒëi·ªán tho·∫°i nh·ªè */
@media (max-width: 480px) {
        .main-container {
        padding: 0 10px;
    }
    .header h1 {
        font-size: 1.6em; /* Gi·∫£m n·ªØa */
    }
    .btn {
        padding: 10px 15px; /* Gi·∫£m padding n√∫t */
        font-size: 13px;
    }
    .tab button {
        padding: 8px 10px;
    }
    th, td {
        padding: 8px 10px; /* Gi·∫£m padding cell */
        font-size: 13px; /* Gi·∫£m font ch·ªØ b·∫£ng */
    }
    .target-input {
        width: 55px; /* Gi·∫£m n·ªØa */
        font-size: 13px;
    }
    .chart-section h2 {
        font-size: 1.4em;
    }
}
    </style>
</head>

<body>
    <!-- Header gi·ªØ nguy√™n -->
    <div class="header">
        <div class="title-wrapper">
            <h1>üèπ Qu·∫£n L√Ω SƒÉn Qu√°i FvN</h1>
        </div>
        <div class="input-actions-group">
            <div class="input-group">
                <input type="text" id="excelUrl" placeholder="D√°n link Google Sheets ho·∫∑c URL Excel..." class="url-input">
                <!-- Th√™m class 'btn' v√† 'btn-primary' -->
                <button class="btn btn-primary" onclick="loadExcelFromUrl()">T·∫£i t·ª´ URL</button>
            </div>
            <div class="file-upload-controls">
                <div class="file-upload-group">
                    <label class="upload-label excel-label" for="excelFile">
                        Ch·ªçn file Excel
                        <span class="file-name" id="excelFileName"></span>
                    </label>
                    <input type="file" id="excelFile" accept=".xlsx, .xls"
                        onchange="document.getElementById('excelFileName').textContent = this.files[0]?.name || ''">
                </div>
                <div class="file-upload-group">
                    <label class="upload-label txt-label" for="txtFile">
                        Ch·ªçn file TXT
                        <span class="file-name" id="txtFileName"></span>
                    </label>
                    <input type="file" id="txtFile" accept=".txt"
                        onchange="document.getElementById('txtFileName').textContent = this.files[0]?.name || ''">
                </div>
                <!-- Th√™m class 'btn' v√† 'btn-primary' -->
                <button class="btn btn-primary process-txt-btn" onclick="processTxtFile()">X·ª≠ l√Ω TXT</button>
            </div>
        </div>
    </div>

    <!-- B·ªçc n·ªôi dung ch√≠nh -->
    <div class="main-container">
        <div class="toolbar">
            <!-- Th√™m class 'btn' v√† 'btn-toggle' -->
            <button class="btn btn-toggle" onclick="toggleQuaiTuan()">·∫®n/Hi·ªán Qu√°i Tu·∫ßn</button>
            <button class="btn btn-toggle" onclick="toggleIdColumn()">·∫®n/Hi·ªán ID</button>
            <!-- Th√™m class 'btn' v√† 'btn-export' -->
            <button class="btn btn-export export-image-btn" onclick="exportToImage()">üì∏ Xu·∫•t ·∫¢nh</button>
            <div class="tab">
                <!-- Th√™m class 'btn' cho c√°c n√∫t tab -->
                <button class="btn active" onclick="showTab('missing')">Thi·∫øu (<span id="missingCount">0</span>)</button>
                <button class="btn" onclick="showTab('sufficient')">ƒê·ªß/D∆∞ (<span id="sufficientCount">0</span>)</button>
                <button class="btn" onclick="showTab('corrected')">ƒê√£ s·ª≠a (<span id="correctedCount">0</span>)</button>
            </div>
            <!-- N√∫t Xu·∫•t Excel s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS, c·∫ßn ƒë·∫£m b·∫£o n√≥ c≈©ng c√≥ class 'btn btn-success' -->
        </div>

        <!-- X√≥a style="display: none;" -->
        <div id="missing" class="tab-content">
            <div id="missingContent"></div>
        </div>
        <div id="sufficient" class="tab-content tab-content-hidden">
            <div id="sufficientContent"></div>
        </div>
        <div id="corrected" class="tab-content tab-content-hidden">
            <div id="correctedContent"></div>
        </div>

        <!-- X√≥a style inline, th√™m class 'chart-section' -->
        <div class="chart-section">
            <h2>üìä Th·ªëng K√™ Nhanh</h2>
            <!-- Th√™m class 'chart-grid' -->
            <div class="chart-grid">
                <!-- X√≥a style inline, th√™m class 'chart-wrapper' -->
                <div class="chart-wrapper">
                    <canvas id="statusChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <canvas id="topPlayersChart"></canvas>
                </div>
            </div>
             <!-- Th√™m class 'btn' v√† 'btn-primary' -->
            <button class="btn btn-primary" onclick="renderCharts()" style="margin-top: 15px;">T·∫°o/C·∫≠p nh·∫≠t Bi·ªÉu ƒê·ªì</button>
        </div>
    </div>

    <script>
        // Khai b√°o bi·∫øn l∆∞u d·ªØ li·ªáu
        let statusChartInstance = null;
        let topPlayersChartInstance = null;        
        let originalData = []; // Th√™m d√≤ng n√†y
        let processedData = [];
        let showQuaiTuan = true;
        let showIdColumn = true;        
        let currentTab = 'missing';

        // X·ª≠ l√Ω hi·ªÉn th·ªã t√™n file
        document.getElementById('excelFile').addEventListener('change', function (e) {
            document.getElementById('excelFileName').textContent = this.files[0]?.name || 'Ch∆∞a ch·ªçn file';
        });

        document.getElementById('txtFile').addEventListener('change', function (e) {
            document.getElementById('txtFileName').textContent = this.files[0]?.name || 'Ch∆∞a ch·ªçn file';
        });
        // === K·∫æT TH√öC PH·∫¶N TH√äM ===

        document.getElementById('excelFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // C·∫≠p nh·∫≠t c·∫£ originalData v√† processedData
                    originalData = processData(jsonData); // D·ªØ li·ªáu g·ªëc
                    processedData = JSON.parse(JSON.stringify(originalData)); // B·∫£n sao ƒë·ªÉ ch·ªânh s·ª≠a
                    currentTab = 'missing';
                    updateUI();

                } catch (error) {
                    alert('L·ªói ƒë·ªçc file: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // H√†m x·ª≠ l√Ω d·ªØ li·ªáu Excel g·ªëc
        function processExcelData(rawData) {
            const headers = rawData[0].map(h => h.trim().toLowerCase());

            return rawData.slice(1).map(row => {
                return {
                    id: parseInt(row[headers.indexOf("user id")]) || 0,
                    name: row[headers.indexOf("name")] || '',
                    levels: {
                        l1: parseInt(row[headers.indexOf("l1 (hunt)")]) || 0,
                        l2: parseInt(row[headers.indexOf("l2 (hunt)")]) || 0,
                        l3: parseInt(row[headers.indexOf("l3 (hunt)")]) || 0,
                        l4: parseInt(row[headers.indexOf("l4 (hunt)")]) || 0,
                        l5: parseInt(row[headers.indexOf("l5 (hunt)")]) || 0
                    },
                    target: 56, // Gi√° tr·ªã m·∫∑c ƒë·ªãnh
                    points: 0,
                    status: 'missing',
                    corrected: false
                };
            }).filter(item => item.id !== 0);
        }

        // H√†m x·ª≠ l√Ω file TXT
        function processTxtFile() {
            const txtFile = document.getElementById('txtFile').files[0];
            const reader = new FileReader();

            reader.onload = function (e) {
                const userIds = e.target.result.split(',').map(id => id.trim());

                // Ch·ªâ c·∫≠p nh·∫≠t processedData, gi·ªØ nguy√™n originalData
                userIds.forEach(uid => {
                    const user = processedData.find(item => String(item.id) === uid);
                    if (user && user.points < user.target) {
                        const needed = user.target - user.points;
                        adjustLevels(user, needed);
                        user.corrected = true;
                    }
                });

                updateUI();
            };
            reader.readAsText(txtFile);
        }

        /* ‚ñº‚ñº‚ñº Th√™m h√†m xu·∫•t ·∫£nh ·ªü ƒë√¢y ‚ñº‚ñº‚ñº */
        async function exportToImage() {
    if (!processedData.length) {
        alert("Vui l√≤ng t·∫£i file Excel tr∆∞·ªõc!");
        return;
    }

    const contentDivId = `${currentTab}Content`;
    const elementToCapture = document.getElementById(contentDivId);

    if (!elementToCapture) {
        alert("Kh√¥ng t√¨m th·∫•y n·ªôi dung ƒë·ªÉ ch·ª•p ·∫£nh.");
        return;
    }

    // Ki·ªÉm tra xem c√≥ b·∫£ng b√™n trong kh√¥ng
    const tableElement = elementToCapture.querySelector('table');
    if (!tableElement) {
        alert(`Kh√¥ng t√¨m th·∫•y b·∫£ng d·ªØ li·ªáu trong tab "${currentTab}" ƒë·ªÉ xu·∫•t ·∫£nh.`);
        return;
    }

    // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang x·ª≠ l√Ω (t√πy ch·ªçn)
    const originalButtonText = document.querySelector('.export-image-btn').textContent;
    document.querySelector('.export-image-btn').textContent = 'üì∏ ƒêang x·ª≠ l√Ω...';
    document.querySelector('.export-image-btn').disabled = true;


    // Th√™m ƒë·ªô tr·ªÖ nh·ªè (v√≠ d·ª•: 100ms) tr∆∞·ªõc khi ch·ª•p
    setTimeout(async () => {
        try {
            console.log("B·∫Øt ƒë·∫ßu ch·ª•p ·∫£nh ph·∫ßn t·ª≠:", contentDivId);
            const canvas = await html2canvas(elementToCapture, {
                scale: 1.5,
                useCORS: true,
                logging: false, // B·∫≠t true ƒë·ªÉ debug n·∫øu c·∫ßn
                // ƒê·∫£m b·∫£o ch·ª•p c·∫£ ph·∫ßn b·ªã cu·ªôn ngang n·∫øu c√≥
                scrollX: 0,
                scrollY: -window.scrollY, // C·∫ßn thi·∫øt n·∫øu trang c√≥ cu·ªôn d·ªçc
                windowWidth: elementToCapture.scrollWidth, // Ch·ª•p theo chi·ªÅu r·ªông n·ªôi dung
                windowHeight: elementToCapture.scrollHeight // Ch·ª•p theo chi·ªÅu cao n·ªôi dung
            });
            console.log("ƒê√£ t·∫°o canvas");

            const imageDataUrl = canvas.toDataURL('image/png');

            // M·ªü ·∫£nh trong tab m·ªõi (t·ªët h∆°n cho iOS)
            const newWindow = window.open();
            if (newWindow) {
                newWindow.document.write(`
                    <html>
                        <head><title>B√°o c√°o ${currentTab}</title></head>
                        <body style="margin:0;">
                            <img src="${imageDataUrl}" alt="B√°o c√°o" style="max-width: 100%; display: block;">
                        </body>
                    </html>`);
                // newWindow.document.title = `BaoCao_${currentTab}_${new Date().toISOString().slice(0, 10)}`; // ƒê·∫∑t title trong head t·ªët h∆°n
            } else {
                alert("Kh√¥ng th·ªÉ m·ªü tab m·ªõi. Vui l√≤ng ki·ªÉm tra c√†i ƒë·∫∑t ch·∫∑n pop-up c·ªßa tr√¨nh duy·ªát v√† th·ª≠ l·∫°i.");
            }

        } catch (error) {
            console.error('L·ªói xu·∫•t ·∫£nh:', error);
            alert(`Xu·∫•t ·∫£nh th·∫•t b·∫°i! L·ªói: ${error.message}. Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c ki·ªÉm tra console.`);
        } finally {
            // Kh√¥i ph·ª•c tr·∫°ng th√°i n√∫t
            document.querySelector('.export-image-btn').textContent = originalButtonText;
            document.querySelector('.export-image-btn').disabled = false;
            console.log("Ho√†n t·∫•t x·ª≠ l√Ω xu·∫•t ·∫£nh.");
        }
    }, 100); // ƒê·ªô tr·ªÖ 100 mili gi√¢y
}


        /* ‚ñ≤‚ñ≤‚ñ≤ K·∫øt th√∫c ph·∫ßn th√™m h√†m ‚ñ≤‚ñ≤‚ñ≤ */

        function processData(data) {
            const result = [];
            if (data.length < 2) return result;

            const headers = data[0].map(h => h.trim().toLowerCase());
            const colIndex = {
                userId: headers.indexOf("user id"),
                name: headers.indexOf("name"),
                l1: headers.indexOf("l1 (hunt)"),
                l2: headers.indexOf("l2 (hunt)"),
                l3: headers.indexOf("l3 (hunt)"),
                l4: headers.indexOf("l4 (hunt)"),
                l5: headers.indexOf("l5 (hunt)")
            };

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                const item = {
                    id: parseInt(row[colIndex.userId]) || 0,
                    name: row[colIndex.name] || '',
                    levels: {
                        l1: parseInt(row[colIndex.l1]) || 0,
                        l2: parseInt(row[colIndex.l2]) || 0,
                        l3: parseInt(row[colIndex.l3]) || 0,
                        l4: parseInt(row[colIndex.l4]) || 0,
                        l5: parseInt(row[colIndex.l5]) || 0
                    },
                    target: 56,
                    status: 'missing'
                };

                calculatePoints(item);
                result.push(item);
            }

            return result.filter(item => item.id !== 0);
        }

        function calculatePoints(item) {
            item.points = item.levels.l2 +
                (item.levels.l3 * 4) +
                (item.levels.l4 * 16) +
                (item.levels.l5 * 32);
            updateStatus(item);
        }

        function updateStatus(item) {
            const diff = item.points - item.target;
            item.status = diff >= 0 ? (diff > 0 ? 'excess' : 'sufficient') : 'missing';
        }
function renderCharts() {
    if (!processedData || processedData.length === 0) {
        alert("Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì. Vui l√≤ng t·∫£i file Excel tr∆∞·ªõc.");
        return;
    }

    // --- D·ªØ li·ªáu cho Bi·ªÉu ƒë·ªì Tr·∫°ng th√°i (Pie Chart) ---
    const statusCounts = {
        missing: processedData.filter(item => item.status === 'missing').length,
        sufficient: processedData.filter(item => item.status === 'sufficient').length,
        excess: processedData.filter(item => item.status === 'excess').length,
    };

    const statusCtx = document.getElementById('statusChart').getContext('2d');

    // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu t·ªìn t·∫°i
    if (statusChartInstance) {
        statusChartInstance.destroy();
    }

    statusChartInstance = new Chart(statusCtx, {
        type: 'doughnut', // Ho·∫∑c 'pie'
        data: {
            labels: ['Thi·∫øu', 'ƒê·ªß', 'D∆∞'],
            datasets: [{
                label: 'Ph√¢n lo·∫°i tr·∫°ng th√°i',
                data: [statusCounts.missing, statusCounts.sufficient, statusCounts.excess],
                backgroundColor: [
                    'rgb(241, 196, 15)', // Warning color (Thi·∫øu)
                    'rgb(46, 204, 113)', // Success color (ƒê·ªß)
                    'rgb(231, 76, 60)'   // Danger color (D∆∞)
                ],
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: 'T·ª∑ l·ªá tr·∫°ng th√°i sƒÉn qu√°i'
                }
            }
        }
    });

    // --- D·ªØ li·ªáu cho Bi·ªÉu ƒë·ªì Top Ng∆∞·ªùi Ch∆°i (Bar Chart) ---
    const topN = 10; // L·∫•y top 10 ng∆∞·ªùi
    const sortedPlayers = [...processedData]
                          .sort((a, b) => b.points - a.points)
                          .slice(0, topN);

    const topPlayersCtx = document.getElementById('topPlayersChart').getContext('2d');

     // H·ªßy bi·ªÉu ƒë·ªì c≈© n·∫øu t·ªìn t·∫°i
    if (topPlayersChartInstance) {
        topPlayersChartInstance.destroy();
    }

    topPlayersChartInstance = new Chart(topPlayersCtx, {
        type: 'bar',
        data: {
            labels: sortedPlayers.map(p => p.name.substring(0, 15) + (p.name.length > 15 ? '...' : '')), // C·∫Øt ng·∫Øn t√™n n·∫øu qu√° d√†i
            datasets: [{
                label: `Top ${topN} ng∆∞·ªùi ch∆°i theo Points Hunt`,
                data: sortedPlayers.map(p => p.points),
                backgroundColor: 'rgba(52, 152, 219, 0.7)', // Primary color with transparency
                borderColor: 'rgb(52, 152, 219)',
                borderWidth: 1
            }]
        },
        options: {
            indexAxis: 'y', // Hi·ªÉn th·ªã thanh ngang ƒë·ªÉ d·ªÖ ƒë·ªçc t√™n
            responsive: true,
            scales: {
                x: {
                    beginAtZero: true
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: `Top ${topN} ng∆∞·ªùi ch∆°i ƒëi·ªÉm cao nh·∫•t`
                },
                legend: {
                    display: false // C√≥ th·ªÉ ·∫©n ch√∫ th√≠ch n·∫øu ch·ªâ c√≥ 1 dataset
                }
            }
        }
    });
}

function updateUI() {
    updateCounts();
    renderTable(currentTab);

    // Ch·ªâ x√≥a n√∫t Excel (class 'download-btn')
    document.querySelector('.download-btn')?.remove();

    createDownloadButton(); // T·∫°o l·∫°i n√∫t Excel m·ªõi

    // G·ªçi h√†m v·∫Ω bi·ªÉu ƒë·ªì (n·∫øu c√≥ d·ªØ li·ªáu)
    if (processedData && processedData.length > 0) {
         // C√≥ th·ªÉ th√™m ƒë·ªô tr·ªÖ nh·ªè ƒë·ªÉ ƒë·∫£m b·∫£o DOM c·∫≠p nh·∫≠t xong
         // setTimeout(renderCharts, 100);
         // Ho·∫∑c g·ªçi tr·ª±c ti·∫øp n·∫øu kh√¥ng g·∫∑p v·∫•n ƒë·ªÅ
         renderCharts();
    }
}


        function updateCounts() {
            const counts = {
                missing: processedData.filter(item => item.status === 'missing').length,
                sufficient: processedData.filter(item => item.status === 'sufficient').length,
                excess: processedData.filter(item => item.status === 'excess').length,
                corrected: processedData.filter(item => item.corrected).length
            };

            document.getElementById('missingCount').textContent = counts.missing;
            document.getElementById('sufficientCount').textContent = counts.sufficient + counts.excess;
            document.getElementById('correctedCount').textContent = counts.corrected;
        }

        // C·∫≠p nh·∫≠t h√†m render cho tab "ƒê√£ s·ª≠a"
        // Trong h√†m renderTable, x√≥a logic x·ª≠ l√Ω tab Top 3
        function renderTable(tabId) {
    let content = '';
    switch (tabId) {
        case 'missing':
            content = generateTable(processedData.filter(item => item.status === 'missing'), 'missing');
            break;
        case 'sufficient':
            const sufficientData = [...processedData]
                .filter(item => item.status !== 'missing')
                .sort((a, b) => b.points - a.points);
            content = generateTable(sufficientData, 'sufficient');
            break;
        case 'corrected':
            if (!originalData || originalData.length === 0) {
                content = '<p class="empty">Ch∆∞a c√≥ d·ªØ li·ªáu g·ªëc</p>';
            } else {
                const correctedIds = processedData.filter(item => item.corrected).map(item => item.id);
                const correctedOriginalData = originalData.filter(item => correctedIds.includes(item.id));
                content = generateTable(correctedOriginalData, 'corrected');
            }
            break;
    }
    document.getElementById(`${tabId}Content`).innerHTML = content;
}

        // S·ª≠a l·∫°i h√†m generateTable ch·ªâ d√πng cho c√°c tab th∆∞·ªùng
        function generateTable(data, tabId) {
            if (!data || data.length === 0) return '<p class="empty">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
        
            const showCheckbox = tabId === 'missing';
        
            // B·ªçc b·∫£ng trong div.table-responsive
            return `
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            ${showCheckbox ? '<th></th>' : ''}
                            <th class="id-column">ID</th>
                            <th>T√™n</th>
                            <th>1</th>
                            <th>2</th>
                            <th>3</th>
                            <th>4</th>
                            <th>5</th>
                            <th class="quai-tuan-column">Qu√°i Tu·∫ßn</th>
                            <th>Points Hunt</th>
                            <th>${tabId === 'sufficient' ? 'D∆∞' : 'Thi·∫øu'}</th>
                            ${tabId !== 'sufficient' ? '<th>B√π</th>' : ''}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(item => `
                            <tr>
                                ${showCheckbox ? `
                                    <td><input type="checkbox" data-id="${item.id}"></td>
                                ` : ''}
                                <td class="id-column">${item.id}</td>
                                <td>${item.name}</td>
                                <td>${item.levels.l1}</td>
                                <td>${item.levels.l2}</td>
                                <td>${item.levels.l3}</td>
                                <td>${item.levels.l4}</td>
                                <td>${item.levels.l5}</td>
                                <td class="quai-tuan-column">
                                    <input type="number"
                                           value="${item.target}"
                                           data-id="${item.id}"
                                           class="target-input">
                                </td>
                                <td>${item.points}</td>
                                <td>${tabId === 'sufficient' ?
                        Math.max(item.points - item.target, 0) :
                        item.target - item.points}
                                </td>
                                ${tabId !== 'sufficient' ? `
                                    <td>${(item.target - item.points) * 2}</td>
                                ` : ''}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
            ${showCheckbox ? `
                <div class="table-footer">
                    <button onclick="processCorrections()">C·∫≠p nh·∫≠t m·ª•c ch·ªçn</button>
                </div>
            ` : ''}
        `;
        }
        
        

        function getStatusText(item) {
            const diff = item.points - item.target;
            if (diff < 0) return `Thi·∫øu ${-diff}`;
            if (diff === 0) return 'ƒê·ªß';
            return `D∆∞ ${diff}`;
        }

        

        // Th√™m h√†m t√≠nh level cao nh·∫•t
        function calculateHighestLevel(levels) {
            const levelValues = [levels.l2, levels.l3, levels.l4, levels.l5];
            let maxLevel = 2;
            levelValues.forEach((val, idx) => {
                if (val > 0) maxLevel = idx + 2;
            });
            return maxLevel;
        }

        // C·∫≠p nh·∫≠t h√†m showTab ƒë·ªÉ d√πng class thay v√¨ style inline
            function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.classList.add('tab-content-hidden'); // Th√™m class ·∫©n
                el.style.display = 'none'; // V·∫´n gi·ªØ display none ƒë·ªÉ ƒë·∫£m b·∫£o ·∫©n ban ƒë·∫ßu
            });
            const activeTabContent = document.getElementById(tabId);
            activeTabContent.classList.remove('tab-content-hidden'); // X√≥a class ·∫©n
            activeTabContent.style.display = 'block'; // Hi·ªÉn th·ªã

            // C·∫≠p nh·∫≠t class 'active' cho n√∫t tab
            document.querySelectorAll('.tab button').forEach(btn => btn.classList.remove('active'));
            // T√¨m n√∫t t∆∞∆°ng ·ª©ng v√† th√™m class active (c·∫ßn ƒë·∫£m b·∫£o onclick c√≥ c√°ch l·∫•y ƒë√∫ng n√∫t)
            // V√≠ d·ª• ƒë∆°n gi·∫£n: t√¨m theo n·ªôi dung text ho·∫∑c th√™m data-tab attribute
             document.querySelector(`.tab button[onclick="showTab('${tabId}')"]`).classList.add('active');


            currentTab = tabId;
            renderTable(tabId);
        }

        function toggleQuaiTuan() {
            showQuaiTuan = !showQuaiTuan;
            // Th√™m/x√≥a class 'hide-quaituan' tr√™n th·∫ª body
            document.body.classList.toggle('hide-quaituan', !showQuaiTuan);
            // Kh√¥ng c·∫ßn render l·∫°i b·∫£ng
        }
        
        function toggleIdColumn() {
            showIdColumn = !showIdColumn;
            // Th√™m/x√≥a class 'hide-id-column' tr√™n th·∫ª body
            document.body.classList.toggle('hide-id-column', !showIdColumn);
            // Kh√¥ng c·∫ßn render l·∫°i b·∫£ng v√¨ CSS s·∫Ω x·ª≠ l√Ω vi·ªác ·∫©n/hi·ªán
        }
        
        // H√†m x·ª≠ l√Ω c·∫≠p nh·∫≠t m·ª•c ch·ªçn
        function processCorrections() {
            const selectedIds = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
                .map(checkbox => parseInt(checkbox.dataset.id));

            processedData.forEach(item => {
                if (selectedIds.includes(item.id)) {
                    const needed = item.target - item.points;
                    if (needed > 0) {
                        adjustLevels(item, needed);
                        item.corrected = true;
                    }
                }
            });

            updateUI();
        }

        function adjustLevels(item, needed) {
            let remaining = needed;
            const add = {
                l5: Math.min(Math.floor(remaining / 32)),
                l4: 0, l3: 0, l2: 0
            };

            remaining %= 32;
            add.l4 = Math.min(Math.floor(remaining / 16));
            remaining %= 16;
            add.l3 = Math.min(Math.floor(remaining / 4));
            remaining %= 4;
            add.l2 = remaining;

            item.levels.l5 += add.l5;
            item.levels.l4 += add.l4;
            item.levels.l3 += add.l3;
            item.levels.l2 += add.l2;

            calculatePoints(item);
        }
         // C·∫≠p nh·∫≠t h√†m createDownloadButton ƒë·ªÉ th√™m class
         function createDownloadButton() {
            // X√≥a n√∫t c≈© tr∆∞·ªõc khi t·∫°o m·ªõi (ƒë·ªÉ tr√°nh tr√πng l·∫∑p)
            document.querySelector('.download-btn')?.remove();

            const btn = document.createElement('button');
            // Th√™m c√°c class c·∫ßn thi·∫øt
            btn.className = 'btn btn-success download-btn'; // Class chung v√† class ri√™ng
            btn.textContent = 'üì• Xu·∫•t Excel';
            btn.onclick = exportToExcel;
            document.querySelector('.toolbar').appendChild(btn);
        }
        // G·ªçi showTab ban ƒë·∫ßu ƒë·ªÉ ·∫©n c√°c tab kh√¥ng active
        document.addEventListener('DOMContentLoaded', () => {
             showTab('missing'); // Hi·ªÉn th·ªã tab m·∫∑c ƒë·ªãnh
        });

        function exportToExcel() {
            const wb = XLSX.utils.book_new();
            const cleanSheetName = (name) => name.replace(/[\\/:*?[\]]/g, '-');

            // ƒê·ªãnh nghƒ©a d·ªØ li·ªáu cho t·ª´ng sheet
            const sheets = {
                "Thi·∫øu": {
                    data: processedData.filter(item => item.status === 'missing'),
                    columns: ["User ID", "Name", "L1 (Hunt)", "L2 (Hunt)", "L3 (Hunt)", "L4 (Hunt)", "L5 (Hunt)", "Qu√°i Tu·∫ßn", "Points Hunt", "Thi·∫øu", "B√π"]
                },
                "ƒê·ªß-D∆∞": {
                    data: processedData.filter(item => item.status !== 'missing'),
                    columns: ["User ID", "Name", "L1 (Hunt)", "L2 (Hunt)", "L3 (Hunt)", "L4 (Hunt)", "L5 (Hunt)", "Qu√°i Tu·∫ßn", "Points Hunt", "D∆∞"]
                },
                "ƒê√£ s·ª≠a": {
                    data: originalData.filter(item =>
                        processedData.some(p => p.id === item.id && p.corrected)
                    ),
                    columns: ["User ID", "Name", "L1 (Hunt)", "L2 (Hunt)", "L3 (Hunt)", "L4 (Hunt)", "L5 (Hunt)", "Qu√°i Tu·∫ßn", "Points Hunt", "Thi·∫øu", "B√π"]
                },
            };

            // T·∫°o t·ª´ng sheet v√† th√™m v√†o workbook
            Object.entries(sheets).forEach(([sheetName, config]) => {
                const wsData = [
                    config.columns, // Header
                    ...config.data.map(item => {
                        const row = {
                            "User ID": item.id,
                            "Name": item.name,
                            "L1 (Hunt)": item.levels.l1,
                            "L2 (Hunt)": item.levels.l2,
                            "L3 (Hunt)": item.levels.l3,
                            "L4 (Hunt)": item.levels.l4,
                            "L5 (Hunt)": item.levels.l5,
                            "Qu√°i Tu·∫ßn": item.target,
                            "Points Hunt": item.points,
                            "Thi·∫øu": item.target - item.points,
                            "B√π": (item.target - item.points) * 2,
                            "D∆∞": Math.max(item.points - item.target, 0),
                            "C·∫•p ƒë·ªô cao nh·∫•t": "L" + calculateHighestLevel(item.levels)
                        };

                        return config.columns.map(col => row[col]);
                    })
                ];

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                XLSX.utils.book_append_sheet(wb, ws, cleanSheetName(sheetName));
            });

            XLSX.writeFile(wb, 'BaoCaoSƒÉnQu√°i.xlsx');
        }
        async function loadExcelFromUrl() {
    const rawUrl = document.getElementById('excelUrl').value.trim();
    console.log("URL g·ªëc:", rawUrl); // Log URL g·ªëc

    if (!rawUrl) {
        alert("Vui l√≤ng nh·∫≠p URL Google Sheets!");
        return;
    }

    // Hi·ªÉn th·ªã th√¥ng b√°o ƒëang x·ª≠ l√Ω (t√πy ch·ªçn)
    // V√≠ d·ª•: document.body.style.cursor = 'wait';

    try {
        // Chuy·ªÉn ƒë·ªïi URL
        let finalUrl = rawUrl
            .replace(/\/edit\?.*$/, '/export')
            .replace(/#gid=.*/, '')
            + '?format=xlsx';
        console.log("URL ƒë√£ chuy·ªÉn ƒë·ªïi:", finalUrl); // Log URL ƒë√£ chuy·ªÉn ƒë·ªïi

        // S·ª≠ d·ª•ng proxy
        const proxyUrl = 'https://api.codetabs.com/v1/proxy?quest=';
        const fetchUrl = proxyUrl + encodeURIComponent(finalUrl);
        console.log("URL Fetch qua Proxy:", fetchUrl); // Log URL s·∫Ω fetch

        const response = await fetch(fetchUrl, {
            // B·ªè User-Agent ƒë·ªÉ th·ª≠ nghi·ªám, Safari c√≥ th·ªÉ t·ª± x·ª≠ l√Ω t·ªët h∆°n
            // headers: {
            //     'User-Agent': 'Mozilla/5.0'
            // }
            // C√≥ th·ªÉ th√™m timeout n·∫øu c·∫ßn
            // signal: AbortSignal.timeout(30000) // Timeout 30 gi√¢y
        });
        console.log("Tr·∫°ng th√°i ph·∫£n h·ªìi:", response.status, response.statusText); // Log tr·∫°ng th√°i

        if (!response.ok) {
            // C·ªë g·∫Øng ƒë·ªçc n·ªôi dung l·ªói n·∫øu c√≥
            let errorBody = await response.text().catch(() => 'Kh√¥ng th·ªÉ ƒë·ªçc n·ªôi dung l·ªói');
            console.error("N·ªôi dung l·ªói t·ª´ proxy/server:", errorBody);
            throw new Error(`L·ªói HTTP: ${response.status} ${response.statusText}`);
        }

        // X·ª≠ l√Ω d·ªØ li·ªáu
        console.log("ƒêang x·ª≠ l√Ω d·ªØ li·ªáu ArrayBuffer...");
        const arrayBuffer = await response.arrayBuffer();
        console.log("ƒê√£ nh·∫≠n ArrayBuffer, k√≠ch th∆∞·ªõc:", arrayBuffer.byteLength);
        const data = new Uint8Array(arrayBuffer);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
        console.log("ƒê√£ ph√¢n t√≠ch d·ªØ li·ªáu JSON t·ª´ Excel.");

        // C·∫≠p nh·∫≠t c·∫£ originalData v√† processedData
        originalData = processData(jsonData); // D·ªØ li·ªáu g·ªëc
        processedData = JSON.parse(JSON.stringify(originalData)); // B·∫£n sao ƒë·ªÉ ch·ªânh s·ª≠a
        currentTab = 'missing'; // Reset v·ªÅ tab m·∫∑c ƒë·ªãnh
        updateUI();
        alert("T·∫£i file th√†nh c√¥ng!");

    } catch (error) {
        console.error("Chi ti·∫øt l·ªói khi t·∫£i URL:", error); // Log l·ªói chi ti·∫øt
        alert(`L·ªói t·∫£i URL: ${error.message || "Ki·ªÉm tra l·∫°i URL, k·∫øt n·ªëi m·∫°ng ho·∫∑c th·ª≠ l·∫°i sau."}`);
    } finally {
        // ·∫®n th√¥ng b√°o ƒëang x·ª≠ l√Ω (n·∫øu c√≥)
        // V√≠ d·ª•: document.body.style.cursor = 'default';
    }
}


        // H√†m ki·ªÉm tra URL h·ª£p l·ªá
        function isValidExcelUrl(url) {
            // Cho ph√©p c·∫£ URL th√¥ng th∆∞·ªùng v√† Google Sheets
            return /(\.xlsx?$)|(docs\.google\.com\/spreadsheets\/d\/)/i.test(url);
        }

        // H√†m x·ª≠ l√Ω thay ƒë·ªïi gi√° tr·ªã Qu√°i Tu·∫ßn
        document.addEventListener('change', function (e) {
            if (e.target.classList.contains('target-input')) {
                const id = parseInt(e.target.dataset.id);
                const newTarget = parseInt(e.target.value) || 56;

                const user = processedData.find(item => item.id === id);
                if (user) {
                    user.target = newTarget;
                    calculatePoints(user);
                    updateUI();
                }
            }
        });

    </script>
</body>
</html>